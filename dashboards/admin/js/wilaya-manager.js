// Données des wilayas d'Algérie
export const wilayasData = [
    { id: '01', code: '01', nom: 'Adrar', designation: 'Wilaya d\'Adrar', zone: 'sud', email: 'adrar@contact.dz', address: 'Rue principale, Adrar', lat: 27.8742, lon: -0.2891 },
    { id: '02', code: '02', nom: 'Chlef', designation: 'Wilaya de Chlef', zone: 'nord', email: 'chlef@contact.dz', address: 'Boulevard central, Chlef' },
    { id: '03', code: '03', nom: 'Laghouat', designation: 'Wilaya de Laghouat', zone: 'sud', email: 'laghouat@contact.dz', address: 'Avenue principale, Laghouat' },
    { id: '04', code: '04', nom: 'Oum El Bouaghi', designation: 'Wilaya d\'Oum El Bouaghi', zone: 'est', email: 'oeb@contact.dz', address: 'Centre ville, Oum El Bouaghi' },
    { id: '05', code: '05', nom: 'Batna', designation: 'Wilaya de Batna', zone: 'est', email: 'batna@contact.dz', address: 'Rue principale, Batna' },
    { id: '06', code: '06', nom: 'Béjaïa', designation: 'Wilaya de Béjaïa', zone: 'est', email: 'bejaia@contact.dz', address: 'Boulevard central, Béjaïa' },
    { id: '07', code: '07', nom: 'Biskra', designation: 'Wilaya de Biskra', zone: 'sud', email: 'biskra@contact.dz', address: 'Avenue principale, Biskra' },
    { id: '08', code: '08', nom: 'Béchar', designation: 'Wilaya de Béchar', zone: 'sud', email: 'bechar@contact.dz', address: 'Centre ville, Béchar' },
    { id: '09', code: '09', nom: 'Blida', designation: 'Wilaya de Blida', zone: 'centre', email: 'blida@contact.dz', address: 'Rue principale, Blida' },
    { id: '10', code: '10', nom: 'Bouira', designation: 'Wilaya de Bouira', zone: 'centre', email: 'bouira@contact.dz', address: 'Boulevard central, Bouira' },
    { id: '11', code: '11', nom: 'Tamanrasset', designation: 'Wilaya de Tamanrasset', zone: 'sud', email: 'tamanrasset@contact.dz', address: 'Avenue principale, Tamanrasset' },
    { id: '12', code: '12', nom: 'Tébessa', designation: 'Wilaya de Tébessa', zone: 'est', email: 'tebessa@contact.dz', address: 'Centre ville, Tébessa' },
    { id: '13', code: '13', nom: 'Tlemcen', designation: 'Wilaya de Tlemcen', zone: 'ouest', email: 'tlemcen@contact.dz', address: 'Rue principale, Tlemcen' },
    { id: '14', code: '14', nom: 'Tiaret', designation: 'Wilaya de Tiaret', zone: 'ouest', email: 'tiaret@contact.dz', address: 'Boulevard central, Tiaret' },
    { id: '15', code: '15', nom: 'Tizi Ouzou', designation: 'Wilaya de Tizi Ouzou', zone: 'centre', email: 'tiziouzou@contact.dz', address: 'Avenue principale, Tizi Ouzou' },
    { id: '16', code: '16', nom: 'Alger', designation: 'Wilaya d\'Alger', zone: 'centre', email: 'alger@contact.dz', address: 'Centre ville, Alger' },
    { id: '17', code: '17', nom: 'Djelfa', designation: 'Wilaya de Djelfa', zone: 'sud', email: 'djelfa@contact.dz', address: 'Rue principale, Djelfa' },
    { id: '18', code: '18', nom: 'Jijel', designation: 'Wilaya de Jijel', zone: 'est', email: 'jijel@contact.dz', address: 'Boulevard central, Jijel' },
    { id: '19', code: '19', nom: 'Sétif', designation: 'Wilaya de Sétif', zone: 'est', email: 'setif@contact.dz', address: 'Avenue principale, Sétif' },
    { id: '20', code: '20', nom: 'Saïda', designation: 'Wilaya de Saïda', zone: 'ouest', email: 'saida@contact.dz', address: 'Centre ville, Saïda' },
    { id: '21', code: '21', nom: 'Skikda', designation: 'Wilaya de Skikda', zone: 'est', email: 'skikda@contact.dz', address: 'Centre ville, Skikda' },
    { id: '22', code: '22', nom: 'Sidi Bel Abbès', designation: 'Wilaya de Sidi Bel Abbès', zone: 'ouest', email: 'sba@contact.dz', address: 'Centre ville, Sidi Bel Abbès' },
    { id: '23', code: '23', nom: 'Annaba', designation: 'Wilaya d\'Annaba', zone: 'est', email: 'annaba@contact.dz', address: 'Centre ville, Annaba' },
    { id: '24', code: '24', nom: 'Guelma', designation: 'Wilaya de Guelma', zone: 'est', email: 'guelma@contact.dz', address: 'Centre ville, Guelma' },
    { id: '25', code: '25', nom: 'Constantine', designation: 'Wilaya de Constantine', zone: 'est', email: 'constantine@contact.dz', address: 'Centre ville, Constantine' },
    { id: '26', code: '26', nom: 'Médéa', designation: 'Wilaya de Médéa', zone: 'centre', email: 'medea@contact.dz', address: 'Centre ville, Médéa' },
    { id: '27', code: '27', nom: 'Mostaganem', designation: 'Wilaya de Mostaganem', zone: 'ouest', email: 'mostaganem@contact.dz', address: 'Centre ville, Mostaganem' },
    { id: '28', code: '28', nom: 'M\'Sila', designation: 'Wilaya de M\'Sila', zone: 'centre', email: 'msila@contact.dz', address: 'Centre ville, M\'Sila' },
    { id: '29', code: '29', nom: 'Mascara', designation: 'Wilaya de Mascara', zone: 'ouest', email: 'mascara@contact.dz', address: 'Centre ville, Mascara' },
    { id: '30', code: '30', nom: 'Ouargla', designation: 'Wilaya d\'Ouargla', zone: 'sud', email: 'ouargla@contact.dz', address: 'Centre ville, Ouargla' },
    { id: '31', code: '31', nom: 'Oran', designation: 'Wilaya d\'Oran', zone: 'ouest', email: 'oran@contact.dz', address: 'Centre ville, Oran' },
    { id: '32', code: '32', nom: 'El Bayadh', designation: 'Wilaya d\'El Bayadh', zone: 'sud', email: 'elbayadh@contact.dz', address: 'Centre ville, El Bayadh' },
    { id: '33', code: '33', nom: 'Illizi', designation: 'Wilaya d\'Illizi', zone: 'sud', email: 'illizi@contact.dz', address: 'Centre ville, Illizi' },
    { id: '34', code: '34', nom: 'Bordj Bou Arreridj', designation: 'Wilaya de Bordj Bou Arreridj', zone: 'est', email: 'bba@contact.dz', address: 'Centre ville, Bordj Bou Arreridj' },
    { id: '35', code: '35', nom: 'Boumerdès', designation: 'Wilaya de Boumerdès', zone: 'centre', email: 'boumerdes@contact.dz', address: 'Centre ville, Boumerdès' },
    { id: '36', code: '36', nom: 'El Tarf', designation: 'Wilaya d\'El Tarf', zone: 'est', email: 'eltarf@contact.dz', address: 'Centre ville, El Tarf' },
    { id: '37', code: '37', nom: 'Tindouf', designation: 'Wilaya de Tindouf', zone: 'sud', email: 'tindouf@contact.dz', address: 'Centre ville, Tindouf' },
    { id: '38', code: '38', nom: 'Tissemsilt', designation: 'Wilaya de Tissemsilt', zone: 'ouest', email: 'tissemsilt@contact.dz', address: 'Centre ville, Tissemsilt' },
    { id: '39', code: '39', nom: 'El Oued', designation: 'Wilaya d\'El Oued', zone: 'sud', email: 'eloued@contact.dz', address: 'Centre ville, El Oued' },
    { id: '40', code: '40', nom: 'Khenchela', designation: 'Wilaya de Khenchela', zone: 'est', email: 'khenchela@contact.dz', address: 'Centre ville, Khenchela' },
    { id: '41', code: '41', nom: 'Souk Ahras', designation: 'Wilaya de Souk Ahras', zone: 'est', email: 'soukahras@contact.dz', address: 'Centre ville, Souk Ahras' },
    { id: '42', code: '42', nom: 'Tipaza', designation: 'Wilaya de Tipaza', zone: 'centre', email: 'tipaza@contact.dz', address: 'Centre ville, Tipaza' },
    { id: '43', code: '43', nom: 'Mila', designation: 'Wilaya de Mila', zone: 'est', email: 'mila@contact.dz', address: 'Centre ville, Mila' },
    { id: '44', code: '44', nom: 'Aïn Defla', designation: 'Wilaya d\'Aïn Defla', zone: 'centre', email: 'aindefla@contact.dz', address: 'Centre ville, Aïn Defla' },
    { id: '45', code: '45', nom: 'Naâma', designation: 'Wilaya de Naâma', zone: 'sud', email: 'naama@contact.dz', address: 'Centre ville, Naâma' },
    { id: '46', code: '46', nom: 'Aïn Témouchent', designation: 'Wilaya d\'Aïn Témouchent', zone: 'ouest', email: 'aintemouchent@contact.dz', address: 'Centre ville, Aïn Témouchent' },
    { id: '47', code: '47', nom: 'Ghardaïa', designation: 'Wilaya de Ghardaïa', zone: 'sud', email: 'ghardaia@contact.dz', address: 'Centre ville, Ghardaïa' },
    { id: '48', code: '48', nom: 'Relizane', designation: 'Wilaya de Relizane', zone: 'ouest', email: 'relizane@contact.dz', address: 'Centre ville, Relizane' },
    { id: '49', code: '49', nom: 'El M\'Ghair', designation: 'Wilaya d\'El M\'Ghair', zone: 'sud', email: 'elmghair@contact.dz', address: 'Centre ville, El M\'Ghair' },
    { id: '50', code: '50', nom: 'El Meniaa', designation: 'Wilaya d\'El Meniaa', zone: 'sud', email: 'elmeniaa@contact.dz', address: 'Centre ville, El Meniaa' },
    { id: '51', code: '51', nom: 'Ouled Djellal', designation: 'Wilaya d\'Ouled Djellal', zone: 'sud', email: 'ouleddjellal@contact.dz', address: 'Centre ville, Ouled Djellal' },
    { id: '52', code: '52', nom: 'Bordj Baji Mokhtar', designation: 'Wilaya de Bordj Baji Mokhtar', zone: 'sud', email: 'bordjbajimokhtar@contact.dz', address: 'Centre ville, Bordj Baji Mokhtar' },
    { id: '53', code: '53', nom: 'Béni Abbès', designation: 'Wilaya de Béni Abbès', zone: 'sud', email: 'beniabbes@contact.dz', address: 'Centre ville, Béni Abbès' },
    { id: '54', code: '54', nom: 'Timimoun', designation: 'Wilaya de Timimoun', zone: 'sud', email: 'timimoun@contact.dz', address: 'Centre ville, Timimoun' },
    { id: '55', code: '55', nom: 'Touggourt', designation: 'Wilaya de Touggourt', zone: 'sud', email: 'touggourt@contact.dz', address: 'Centre ville, Touggourt' },
    { id: '56', code: '56', nom: 'Djanet', designation: 'Wilaya de Djanet', zone: 'sud', email: 'djanet@contact.dz', address: 'Centre ville, Djanet' },
    { id: '57', code: '57', nom: 'In Salah', designation: 'Wilaya d\'In Salah', zone: 'sud', email: 'insalah@contact.dz', address: 'Centre ville, In Salah' },
    { id: '58', code: '58', nom: 'In Guezzam', designation: 'Wilaya d\'In Guezzam', zone: 'sud', email: 'inguezzam@contact.dz', address: 'Centre ville, In Guezzam' }
];

class WilayaManager {
    constructor() {
        this.wilayas = [];
        this.loadWilayas();
    }

    // ✅ Obtenir le token admin
    getAdminToken() {
        // ✅ Lire depuis sessionStorage (nouveau système AuthService)
        let token = sessionStorage.getItem('auth_token');
        
        // Fallback sur localStorage pour compatibilité
        if (!token) {
            token = localStorage.getItem('admin_token');
        }
        
        if (!token) {
            console.warn('⚠️ Pas de token admin - utilisateur non connecté');
        }
        return token;
    }

    // ✅ MIGRATION API : Charger les wilayas depuis l'API
    async loadWilayas() {
        console.log('📦 Chargement des wilayas depuis l\'API...');
        
        const token = this.getAdminToken();
        if (!token) {
            console.warn('⚠️ Pas de token, impossible de charger les wilayas');
            this.wilayas = [];
            this.updateUI();
            return;
        }
        
        try {
            const response = await fetch(`${window.API_CONFIG.API_URL}/wilayas`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('✅ Réponse API wilayas:', result);
            
            // L'API retourne { success: true, data: [...] }
            this.wilayas = result.data || [];
            console.log(`✅ ${this.wilayas.length} wilayas chargées depuis l'API`);
            
            // Mettre à jour l'interface
            this.updateUI();
            
        } catch (error) {
            console.error('❌ Erreur lors du chargement des wilayas:', error);
            this.wilayas = [];
            this.updateUI();
        }
    }

    // ❌ SUPPRIMÉ : Plus besoin de saveWilayas() avec localStorage
    // Les wilayas sont maintenant sauvegardées directement dans l'API

    // ✅ MIGRATION API : Ajouter une wilaya via l'API
    async addWilaya(wilayaData) {
        console.log('📦 Création de wilaya via API...', wilayaData);
        
        if (!wilayaData || !wilayaData.code || !wilayaData.nom) {
            alert('❌ Données de wilaya invalides');
            return false;
        }
        
        const token = this.getAdminToken();
        if (!token) {
            alert('⚠️ Session expirée. Veuillez vous reconnecter.');
            window.location.href = '../../login.html';
            return false;
        }

        try {
            // Préparer les données pour l'API
            const apiData = {
                code: wilayaData.code,
                nom: wilayaData.nom,
                designation: wilayaData.designation || `Wilaya de ${wilayaData.nom}`,
                zone: wilayaData.zone || 'centre',
                email: wilayaData.email || `${wilayaData.code}@contact.dz`,
                address: wilayaData.address || `Centre ville, ${wilayaData.nom}`,
                status: wilayaData.status || 'active'
            };

            console.log('📤 Envoi vers API:', apiData);

            const response = await fetch(`${window.API_CONFIG.API_URL}/wilayas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(apiData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Erreur HTTP: ${response.status}`);
            }

            const result = await response.json();
            console.log('✅ Wilaya créée avec succès:', result);

            // Recharger les wilayas depuis l'API
            await this.loadWilayas();

            alert('✅ Wilaya créée avec succès !');
            return true;

        } catch (error) {
            console.error('❌ Erreur lors de la création de la wilaya:', error);
            alert(`❌ Erreur: ${error.message}`);
            return false;
        }
    }

    updateUI() {
        console.log('✅ Mise à jour de l\'UI avec les wilayas depuis l\'API');
        
        // ✅ Utiliser les wilayas chargées depuis l'API (this.wilayas)
        const savedWilayas = this.wilayas;

        // Mettre à jour les statistiques avec les wilayas depuis l'API
        const totalWilayas = document.getElementById('totalWilayas');
        if (totalWilayas) {
            totalWilayas.textContent = savedWilayas.length;
        } else {
            console.warn('Element totalWilayas non trouvé');
        }

        // Mettre à jour le tableau
        const tableBody = document.querySelector('#wilayasTable tbody');
        if (!tableBody) {
            console.warn('Table body non trouvé');
            return;
        }

        // Afficher toutes les wilayas chargées depuis l'API
        tableBody.innerHTML = savedWilayas.filter(wilaya => wilaya && wilaya.code).map(wilaya => {
            // Utiliser _id (MongoDB) ou id (legacy) pour identifier la wilaya
            const wilayaId = wilaya._id || wilaya.id;
            
            return `
            <tr>
                <td>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="wilaya_${wilaya.code}" />
                        <label for="wilaya_${wilaya.code}"></label>
                    </div>
                </td>
                <td>${wilaya.code || ''}</td>
                <td>${wilaya.nom || ''}</td>
                <td>${wilaya.designation || (wilaya.nom ? `Wilaya de ${wilaya.nom}` : '')}</td>
                <td>${wilaya.zone || 'centre'}</td>
                <td>${wilaya.email || '-'}</td>
                <td><span class="status ${wilaya.status === 'inactive' ? 'danger' : 'success'}">${wilaya.status === 'inactive' ? 'Inactive' : 'Active'}</span></td>
                <td class="actions">
                    <div class="action-buttons">
                        <button class="btn-action view" onclick="window.handleWilayaAction('view', '${wilayaId}')" title="Voir les détails">
                            <ion-icon name="eye-outline"></ion-icon>
                        </button>
                        <button class="btn-action edit" onclick="window.handleWilayaAction('edit', '${wilayaId}')" title="Modifier">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn-action delete" onclick="window.handleWilayaAction('delete', '${wilayaId}')" title="Supprimer">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        }).join('');
        
        console.log(`✅ Tableau des wilayas mis à jour avec ${savedWilayas.length} wilayas`);
    }

    getDelaiByZone(zone) {
        if (!zone) return '48h';
        switch(zone.toLowerCase()) {
            case 'nord': return '24h';
            case 'centre': return '48h';
            case 'est':
            case 'ouest': return '48h';
            case 'sud': return '72h';
            default: return '48h';
        }
    }

    // ✅ MIGRATION API : Supprimer une wilaya via l'API
    async deleteWilaya(id) {
        console.log('🗑️ Suppression de wilaya via API:', id);
        
        const token = this.getAdminToken();
        if (!token) {
            alert('⚠️ Session expirée. Veuillez vous reconnecter.');
            window.location.href = '../../login.html';
            return;
        }

        if (!confirm('⚠️ Êtes-vous sûr de vouloir supprimer cette wilaya ?')) {
            return;
        }

        try {
            // Trouver la wilaya pour obtenir son code
            const wilaya = this.getWilaya(id);
            if (!wilaya) {
                alert('❌ Wilaya non trouvée');
                return;
            }

            const response = await fetch(`${window.API_CONFIG.API_URL}/wilayas/${wilaya.code}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Erreur HTTP: ${response.status}`);
            }

            console.log('✅ Wilaya supprimée avec succès');

            // Recharger les wilayas depuis l'API
            await this.loadWilayas();

            alert('✅ Wilaya supprimée avec succès !');

        } catch (error) {
            console.error('❌ Erreur lors de la suppression de la wilaya:', error);
            alert(`❌ Erreur: ${error.message}`);
        }
    }

    getWilaya(id) {
        return this.wilayas.find(w => w.id === id || w._id === id);
    }

    // ✅ MIGRATION API : Modifier une wilaya via l'API
    async updateWilaya(id, data) {
        console.log('📝 Modification de wilaya via API:', id, data);
        
        const token = this.getAdminToken();
        if (!token) {
            alert('⚠️ Session expirée. Veuillez vous reconnecter.');
            window.location.href = '../../login.html';
            return;
        }

        try {
            // Trouver la wilaya pour obtenir son code
            const wilaya = this.getWilaya(id);
            if (!wilaya) {
                alert('❌ Wilaya non trouvée');
                return;
            }

            // Préparer les données pour l'API
            const apiData = {
                nom: data.nom || wilaya.nom,
                designation: data.designation || wilaya.designation,
                zone: data.zone || wilaya.zone,
                email: data.email || wilaya.email,
                address: data.address || wilaya.address,
                status: data.status || wilaya.status
            };

            console.log('📤 Envoi vers API:', apiData);

            const response = await fetch(`${window.API_CONFIG.API_URL}/wilayas/${wilaya.code}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(apiData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Erreur HTTP: ${response.status}`);
            }

            const result = await response.json();
            console.log('✅ Wilaya modifiée avec succès:', result);

            // Recharger les wilayas depuis l'API
            await this.loadWilayas();

            alert('✅ Wilaya modifiée avec succès !');

        } catch (error) {
            console.error('❌ Erreur lors de la modification de la wilaya:', error);
            alert(`❌ Erreur: ${error.message}`);
        }
    }

    viewWilaya(id) {
        const wilaya = this.getWilaya(id);
        if (wilaya) {
            alert(`Détails de la wilaya:\n\nCode: ${wilaya.code}\nNom: ${wilaya.nom}\nDésignation: ${wilaya.designation}\nZone: ${wilaya.zone}\nEmail: ${wilaya.email}\nStatus: ${wilaya.status}`);
        }
    }
}

// Create instance
const wilayaManager = new WilayaManager();

// Global action handler for wilaya actions
window.handleWilayaAction = async (action, id) => {
    switch (action) {
        case 'view':
            wilayaManager.viewWilaya(id);
            break;
        case 'edit':
            const wilaya = wilayaManager.getWilaya(id);
            if (wilaya) {
                const wilayaModal = document.getElementById('wilayaModal');
                const wilayaForm = document.getElementById('wilayaForm');
                
                document.getElementById('wilayaSelect').value = wilaya.code;
                document.getElementById('wilayaStatus').value = wilaya.status || 'active';
                document.getElementById('wilayaEmail').value = wilaya.email || '';
                document.getElementById('wilayaPassword').value = wilaya.password || '';
                document.getElementById('wilayaDesignation').value = wilaya.designation || '';
                
                wilayaForm.dataset.editId = id;
                wilayaModal.style.display = 'flex';
            }
            break;
        case 'delete':
            await wilayaManager.deleteWilaya(id);  // ✅ await
            break;
    }
};

function initializeWilayaHandlers() {
    const wilayaForm = document.getElementById('wilayaForm');
    const addWilayaBtn = document.getElementById('addWilayaBtn');
    const wilayaModal = document.getElementById('wilayaModal');
    
    // Remplir le select de wilayas et ajouter un écouteur d'événements
    const wilayaSelect = document.getElementById('wilayaSelect');
    if (wilayaSelect) {
        wilayaSelect.innerHTML = `
            <option value="">Sélectionner une wilaya...</option>
            ${wilayasData.map(w => `
                <option value="${w.code}">${w.code} - ${w.nom}</option>
            `).join('')}
        `;

        // Écouter les changements de sélection
        wilayaSelect.addEventListener('change', function() {
            const selectedCode = this.value;
            const selectedWilaya = wilayasData.find(w => w.code === selectedCode);
            
            // Effacer les champs si aucune sélection
            if (!selectedCode) {
                document.getElementById('wilayaCode').value = '';
                document.getElementById('wilayaNom').value = '';
                document.getElementById('wilayaDesignation').value = '';
                document.getElementById('wilayaZone').value = '';
                document.getElementById('wilayaEmail').value = '';
                document.getElementById('wilayaPassword').value = '';
                return;
            }
            
            if (selectedWilaya) {
                document.getElementById('wilayaCode').value = selectedWilaya.code;
                document.getElementById('wilayaNom').value = selectedWilaya.nom;
                document.getElementById('wilayaDesignation').value = selectedWilaya.designation || '';
                document.getElementById('wilayaZone').value = selectedWilaya.zone;
                document.getElementById('wilayaEmail').value = selectedWilaya.email || '';
                document.getElementById('wilayaPassword').value = selectedWilaya.password || '';
            }
        });
    }

    if (addWilayaBtn) {
        addWilayaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            wilayaModal.style.display = 'flex';
        });
    }

    if (wilayaForm) {
        wilayaForm.addEventListener('submit', async function(e) {  // ✅ async
            e.preventDefault();
            
            const wilayaSelect = document.getElementById('wilayaSelect');
            const selectedCode = wilayaSelect.value;
            const isEditMode = !!wilayaForm.dataset.editId;
            
            // Validation en mode création
            if (!isEditMode) {
                if (!selectedCode || selectedCode.trim() === '') {
                    e.stopPropagation();
                    alert('Veuillez sélectionner une wilaya');
                    wilayaSelect.focus();
                    return false;
                }
            }

            const wilayaStatus = document.getElementById('wilayaStatus').value;
            const wilayaEmail = document.getElementById('wilayaEmail').value;
            const wilayaPassword = document.getElementById('wilayaPassword').value;
            const wilayaDesignation = document.getElementById('wilayaDesignation').value;

            // Vérifier que tous les champs requis sont remplis
            if (!wilayaEmail || !wilayaPassword) {
                alert('Veuillez remplir l\'email et le mot de passe');
                return;
            }
            
            // En mode création, vérifier la sélection de wilaya
            const selectedWilaya = wilayasData.find(w => w.code === selectedCode);
            if (!isEditMode && !selectedWilaya) {
                alert('Veuillez sélectionner une wilaya valide');
                return;
            }
            
            if (selectedWilaya) {
                // Vérifier si cette wilaya existe déjà
                const existingWilaya = wilayaManager.wilayas.find(w => w.code === selectedCode);
                if (existingWilaya && !wilayaForm.dataset.editId) {
                    alert('Cette wilaya existe déjà');
                    return;
                }

                // Construire les données de la wilaya
                const wilayaData = {
                    ...(isEditMode ? wilayaManager.getWilaya(wilayaForm.dataset.editId) : selectedWilaya),
                    code: selectedWilaya ? selectedWilaya.code : '',
                    nom: selectedWilaya ? selectedWilaya.nom : '',
                    zone: selectedWilaya ? selectedWilaya.zone : '',
                    email: wilayaEmail,
                    password: wilayaPassword,
                    designation: wilayaDesignation || (selectedWilaya ? `Wilaya de ${selectedWilaya.nom}` : ''),
                    status: wilayaStatus || 'active',
                    id: wilayaForm.dataset.editId || Date.now().toString()
                };

                // ✅ await pour les appels API
                if (wilayaForm.dataset.editId) {
                    await wilayaManager.updateWilaya(wilayaForm.dataset.editId, wilayaData);
                } else {
                    await wilayaManager.addWilaya(wilayaData);
                }
            }

            wilayaModal.style.display = 'none';
            wilayaForm.reset();
        });
    }

    // Délégation d'événements pour les boutons d'action
    const wilayasTable = document.getElementById('wilayasTable');
    if (wilayasTable) {
        wilayasTable.addEventListener('click', async (e) => {  // ✅ async
            const target = e.target.closest('.action-btn');
            if (!target) return;

            const id = target.dataset.id;
            if (target.classList.contains('delete')) {
                if (confirm('Êtes-vous sûr de vouloir supprimer cette wilaya ?')) {
                    await wilayaManager.deleteWilaya(id);  // ✅ await
                }
            } else if (target.classList.contains('edit')) {
                const wilaya = wilayaManager.getWilaya(id);
                if (wilaya) {
                    document.getElementById('wilayaSelect').value = wilaya.code;
                    document.getElementById('wilayaStatus').value = wilaya.status || 'active';
                    document.getElementById('wilayaEmail').value = wilaya.email || '';
                    document.getElementById('wilayaPassword').value = wilaya.password || '';
                    document.getElementById('wilayaDesignation').value = wilaya.designation || '';
                    wilayaModal.style.display = 'flex';
                    // Stocker l'ID pour l'édition
                    wilayaForm.dataset.editId = id;
                }
            }
        });
    }

    // Fermeture du modal
    const closeButton = wilayaModal?.querySelector('.close-button');
    if (closeButton) {
        closeButton.addEventListener('click', () => {
            wilayaModal.style.display = 'none';
            
            // Réinitialiser complètement le formulaire
            wilayaForm.reset();
            document.getElementById('wilayaSelect').value = '';
            document.getElementById('wilayaCode').value = '';
            document.getElementById('wilayaNom').value = '';
            document.getElementById('wilayaDesignation').value = '';
            document.getElementById('wilayaZone').value = '';
            document.getElementById('wilayaEmail').value = '';
            document.getElementById('wilayaPassword').value = '';
            
            delete wilayaForm.dataset.editId;
        });
    }

    // Fermer le modal en cliquant en dehors
    window.addEventListener('click', (e) => {
        if (e.target === wilayaModal) {
            wilayaModal.style.display = 'none';
            wilayaForm.reset();
            delete wilayaForm.dataset.editId;
        }
    });
}

// Initialiser au chargement
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM chargé');
    try {
        initializeWilayaHandlers();
        // Charger les wilayas initiales
        wilayaManager.loadWilayas();
        console.log('Initialisation terminée');
    } catch (error) {
        console.error('Erreur lors de l\'initialisation:', error);
    }
});

// Exporter les fonctions nécessaires
export { initializeWilayaHandlers, wilayaManager };