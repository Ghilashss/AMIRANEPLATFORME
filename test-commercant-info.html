<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Info Commer√ßant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #0b2b24;
      margin-top: 0;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border-left: 4px solid #0b2b24;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    button {
      background: #0b2b24;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0a241f;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>üîç Diagnostic Info Commer√ßant</h2>
    <button onclick="testLocalStorage()">1Ô∏è‚É£ Tester localStorage</button>
    <button onclick="testAgenceAPI()">2Ô∏è‚É£ Tester API Agence</button>
    <button onclick="testFull()">3Ô∏è‚É£ Test Complet</button>
    <button onclick="clearStorage()">üóëÔ∏è Vider localStorage</button>
  </div>

  <div id="results"></div>

  <script>
    const CONFIG = {
      API_URL: 'http://localhost:1000/api',
      TOKEN_KEY: 'commercant_token',
      USER_KEY: 'commercant_user'
    };

    function log(title, content, type = 'info') {
      const div = document.createElement('div');
      div.className = 'card';
      
      let statusClass = '';
      if (type === 'success') statusClass = 'success';
      if (type === 'error') statusClass = 'error';
      if (type === 'warning') statusClass = 'warning';
      
      div.innerHTML = `
        <h2>${title}</h2>
        <div class="status ${statusClass}">
          <pre>${JSON.stringify(content, null, 2)}</pre>
        </div>
      `;
      
      document.getElementById('results').appendChild(div);
    }

    function testLocalStorage() {
      document.getElementById('results').innerHTML = '';
      
      const token = localStorage.getItem(CONFIG.TOKEN_KEY);
      const userStr = localStorage.getItem(CONFIG.USER_KEY);
      
      log('üîë Token', token ? token.substring(0, 50) + '...' : '‚ùå ABSENT', token ? 'success' : 'error');
      
      if (userStr) {
        try {
          const user = JSON.parse(userStr);
          log('üë§ User Data', {
            nom: user.nom,
            prenom: user.prenom,
            email: user.email,
            role: user.role,
            agence: user.agence,
            wilaya: user.wilaya
          }, 'success');
          
          if (!user.agence) {
            log('‚ö†Ô∏è Attention', 'Cet utilisateur n\'a PAS d\'agence assign√©e', 'warning');
          }
        } catch (e) {
          log('‚ùå Erreur Parse User', e.message, 'error');
        }
      } else {
        log('‚ùå User Data', 'ABSENT - Vous devez vous connecter', 'error');
      }
      
      // V√©rifier aussi les autres cl√©s
      log('üìã Toutes les cl√©s localStorage', {
        'commercant_token': !!localStorage.getItem('commercant_token'),
        'commercant_user': !!localStorage.getItem('commercant_user'),
        'agent_token': !!localStorage.getItem('agent_token'),
        'agent_user': !!localStorage.getItem('agent_user'),
        'admin_token': !!localStorage.getItem('admin_token'),
        'admin_user': !!localStorage.getItem('admin_user'),
        'token': !!localStorage.getItem('token'),
        'user': !!localStorage.getItem('user')
      }, 'info');
    }

    async function testAgenceAPI() {
      document.getElementById('results').innerHTML = '';
      
      const token = localStorage.getItem(CONFIG.TOKEN_KEY);
      const userStr = localStorage.getItem(CONFIG.USER_KEY);
      
      if (!token || !userStr) {
        log('‚ùå Erreur', 'Token ou User absent. Connectez-vous d\'abord.', 'error');
        return;
      }
      
      const user = JSON.parse(userStr);
      
      if (!user.agence) {
        log('‚ö†Ô∏è Attention', 'L\'utilisateur n\'a pas d\'agence assign√©e', 'warning');
        return;
      }
      
      log('üì° Appel API', `GET /api/agences/${user.agence}`, 'info');
      
      try {
        const response = await fetch(`${CONFIG.API_URL}/agences/${user.agence}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        log('üìä R√©ponse HTTP', { status: response.status, statusText: response.statusText }, 
          response.ok ? 'success' : 'error');
        
        if (response.ok) {
          const result = await response.json();
          log('‚úÖ Donn√©es Agence', result, 'success');
          
          if (result.success && result.data) {
            log('üè¢ Agence trouv√©e', {
              nom: result.data.nom,
              code: result.data.code,
              wilaya: result.data.wilaya,
              telephone: result.data.telephone
            }, 'success');
          }
        } else {
          const error = await response.text();
          log('‚ùå Erreur API', error, 'error');
        }
      } catch (error) {
        log('‚ùå Erreur R√©seau', error.message, 'error');
      }
    }

    async function testFull() {
      document.getElementById('results').innerHTML = '';
      
      log('üöÄ Test Complet D√©marr√©', 'Simulation de loadCommercantInfo()', 'info');
      
      try {
        // √âtape 1: V√©rifier localStorage
        const userStr = localStorage.getItem(CONFIG.USER_KEY);
        const token = localStorage.getItem(CONFIG.TOKEN_KEY);

        if (!userStr) {
          log('‚ùå √âtape 1', 'Utilisateur non connect√©', 'error');
          return;
        }

        const user = JSON.parse(userStr);
        log('‚úÖ √âtape 1', 'User r√©cup√©r√©: ' + user.nom + ' ' + (user.prenom || ''), 'success');

        // √âtape 2: Affichage nom et email (simulation)
        log('‚úÖ √âtape 2', {
          'Nom affich√©': user.nom + (user.prenom ? ' ' + user.prenom : ''),
          'Email affich√©': user.email || ''
        }, 'success');

        // √âtape 3: V√©rifier agence
        if (!user.agence) {
          log('‚ö†Ô∏è √âtape 3', 'Pas d\'agence assign√©e - affichera "Aucune agence"', 'warning');
          return;
        }

        if (!token) {
          log('‚ùå √âtape 3', 'Token manquant', 'error');
          return;
        }

        log('üîÑ √âtape 3', 'Chargement agence: ' + user.agence, 'info');

        // √âtape 4: Appel API
        const response = await fetch(`${CONFIG.API_URL}/agences/${user.agence}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        log('üì° √âtape 4', {
          status: response.status,
          ok: response.ok
        }, response.ok ? 'success' : 'error');

        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            const agence = result.data;
            const agenceNom = agence.nom || `Agence ${agence.wilaya}`;
            
            log('‚úÖ R√âSULTAT FINAL', {
              'Nom commer√ßant': user.nom + (user.prenom ? ' ' + user.prenom : ''),
              'Email': user.email,
              'Agence': agenceNom
            }, 'success');
          } else {
            log('‚ö†Ô∏è √âtape 5', 'Agence inconnue (structure inattendue)', 'warning');
          }
        } else {
          log('‚ùå √âtape 4', 'Erreur HTTP: ' + response.status, 'error');
        }
      } catch (error) {
        log('‚ùå ERREUR GLOBALE', error.message, 'error');
        console.error(error);
      }
    }

    function clearStorage() {
      if (confirm('‚ö†Ô∏è Voulez-vous vraiment vider tout le localStorage ?')) {
        localStorage.clear();
        log('üóëÔ∏è localStorage vid√©', 'Rechargez la page et reconnectez-vous', 'warning');
      }
    }

    // Test auto au chargement
    window.addEventListener('load', () => {
      setTimeout(testLocalStorage, 500);
    });
  </script>
</body>
</html>
