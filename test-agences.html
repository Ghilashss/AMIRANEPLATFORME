<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ajout Agence</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #0b2b24;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0a231e;
        }
        #logs {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test d'Ajout d'Agences</h1>
    
    <div class="test-section">
        <h2>Wilayas (PrÃ©requis)</h2>
        <button onclick="addTestWilaya()">ğŸŒ Ajouter des wilayas de test</button>
        <button onclick="showWilayas()">ğŸ“‹ Afficher les wilayas</button>
        <button onclick="clearWilayas()">ğŸ—‘ï¸ Effacer les wilayas</button>
    </div>
    
    <div class="test-section">
        <h2>Agences</h2>
        <button onclick="testAddAgence()">â• Ajouter une agence de test</button>
        <button onclick="showAgences()">ğŸ“‹ Afficher toutes les agences</button>
        <button onclick="clearAgences()">ğŸ—‘ï¸ Effacer toutes les agences</button>
    </div>
    
    <div class="test-section">
        <h2>Utilitaires</h2>
        <button onclick="clearLogs()">ğŸ§¹ Effacer les logs</button>
        <button onclick="clearAll()">ğŸ”¥ Tout effacer (wilayas + agences)</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š Logs</h2>
        <div id="logs"></div>
    </div>

    <script type="module">
        import { agenceStore } from './dashboards/shared/agence-store.js';
        
        window.agenceStore = agenceStore;
        
        let logCounter = 0;
        
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logCounter++;
            logsDiv.innerHTML += `<div class="${type}">[${logCounter}] ${timestamp} - ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        window.testAddAgence = function() {
            addLog('ğŸ”µ DÃ©but du test d\'ajout d\'agence', 'info');
            
            try {
                // VÃ©rifier qu'il y a au moins une wilaya
                const wilayas = localStorage.getItem('wilayas');
                if (!wilayas) {
                    addLog('âŒ Aucune wilaya trouvÃ©e. Veuillez d\'abord ajouter une wilaya.', 'error');
                    return;
                }
                
                const wilayasArray = JSON.parse(wilayas);
                if (wilayasArray.length === 0) {
                    addLog('âŒ Aucune wilaya trouvÃ©e. Veuillez d\'abord ajouter une wilaya.', 'error');
                    return;
                }
                
                const wilaya = wilayasArray[0];
                addLog(`ğŸ“ Wilaya sÃ©lectionnÃ©e: ${wilaya.code} - ${wilaya.nom}`, 'info');
                
                // CrÃ©er une agence de test
                const testAgence = {
                    nom: `Agence Test ${Date.now()}`,
                    wilaya: wilaya.code,
                    wilayaText: wilaya.nom,
                    telephone: '0555123456',
                    email: 'test@example.com',
                    password: 'test123'
                };
                
                addLog(`ğŸ“¦ DonnÃ©es de l'agence: ${JSON.stringify(testAgence, null, 2)}`, 'info');
                
                // Ajouter l'agence
                const result = agenceStore.addAgence(testAgence);
                
                addLog(`âœ… Agence ajoutÃ©e avec succÃ¨s: ${result.code} - ${result.nom}`, 'success');
                addLog(`ğŸ†” ID: ${result.id}`, 'info');
                
                // VÃ©rifier dans localStorage
                const savedAgences = localStorage.getItem('agences');
                const agencesArray = JSON.parse(savedAgences);
                addLog(`ğŸ’¾ Nombre d'agences dans localStorage: ${agencesArray.length}`, 'info');
                
            } catch (error) {
                addLog(`âŒ Erreur: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.showAgences = function() {
            addLog('ğŸ“‹ Lecture des agences...', 'info');
            
            try {
                const savedAgences = localStorage.getItem('agences');
                
                if (!savedAgences) {
                    addLog('âš ï¸ Aucune agence trouvÃ©e dans localStorage', 'info');
                    return;
                }
                
                const agences = JSON.parse(savedAgences);
                addLog(`ğŸ“Š Nombre total d'agences: ${agences.length}`, 'success');
                
                agences.forEach((agence, index) => {
                    addLog(`   ${index + 1}. ${agence.code} - ${agence.nom} (${agence.wilayaText})`, 'info');
                });
                
            } catch (error) {
                addLog(`âŒ Erreur: ${error.message}`, 'error');
            }
        };
        
        window.clearAgences = function() {
            if (confirm('âš ï¸ Voulez-vous vraiment effacer TOUTES les agences ?')) {
                localStorage.removeItem('agences');
                addLog('ğŸ—‘ï¸ Toutes les agences ont Ã©tÃ© supprimÃ©es', 'info');
                document.dispatchEvent(new CustomEvent('agencesUpdated'));
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
            logCounter = 0;
        };
        
        window.addTestWilaya = function() {
            addLog('ğŸŒ Ajout des wilayas de test...', 'info');
            
            const testWilayas = [
                {
                    id: "1760423519791",
                    code: "01",
                    nom: "Adrar",
                    designation: "Wilaya d'Adrar",
                    zone: "sud",
                    email: "adrar@contact.dz",
                    address: "Centre ville, Adrar",
                    password: "adrar123",
                    status: "active"
                },
                {
                    id: "1760423519792",
                    code: "16",
                    nom: "Alger",
                    designation: "Wilaya d'Alger",
                    zone: "centre",
                    email: "alger@contact.dz",
                    address: "Centre ville, Alger",
                    password: "alger123",
                    status: "active"
                },
                {
                    id: "1760423519793",
                    code: "31",
                    nom: "Oran",
                    designation: "Wilaya d'Oran",
                    zone: "ouest",
                    email: "oran@contact.dz",
                    address: "Centre ville, Oran",
                    password: "oran123",
                    status: "active"
                },
                {
                    id: "1760423519794",
                    code: "25",
                    nom: "Constantine",
                    designation: "Wilaya de Constantine",
                    zone: "est",
                    email: "constantine@contact.dz",
                    address: "Centre ville, Constantine",
                    password: "constantine123",
                    status: "active"
                }
            ];
            
            localStorage.setItem('wilayas', JSON.stringify(testWilayas));
            addLog(`âœ… ${testWilayas.length} wilayas ajoutÃ©es avec succÃ¨s`, 'success');
            
            testWilayas.forEach(w => {
                addLog(`   ğŸ“ ${w.code} - ${w.nom}`, 'info');
            });
        };
        
        window.showWilayas = function() {
            addLog('ğŸ“‹ Lecture des wilayas...', 'info');
            
            try {
                const savedWilayas = localStorage.getItem('wilayas');
                
                if (!savedWilayas) {
                    addLog('âš ï¸ Aucune wilaya trouvÃ©e dans localStorage', 'info');
                    addLog('ğŸ’¡ Cliquez sur "Ajouter des wilayas de test" pour en crÃ©er', 'info');
                    return;
                }
                
                const wilayas = JSON.parse(savedWilayas);
                addLog(`ğŸ“Š Nombre total de wilayas: ${wilayas.length}`, 'success');
                
                wilayas.forEach((wilaya, index) => {
                    addLog(`   ${index + 1}. ${wilaya.code} - ${wilaya.nom} (${wilaya.zone})`, 'info');
                });
                
            } catch (error) {
                addLog(`âŒ Erreur: ${error.message}`, 'error');
            }
        };
        
        window.clearWilayas = function() {
            if (confirm('âš ï¸ Voulez-vous vraiment effacer TOUTES les wilayas ?')) {
                localStorage.removeItem('wilayas');
                addLog('ğŸ—‘ï¸ Toutes les wilayas ont Ã©tÃ© supprimÃ©es', 'info');
            }
        };
        
        window.clearAll = function() {
            if (confirm('âš ï¸âš ï¸âš ï¸ Voulez-vous vraiment TOUT effacer (wilayas + agences) ?')) {
                localStorage.removeItem('wilayas');
                localStorage.removeItem('agences');
                addLog('ğŸ”¥ Tout a Ã©tÃ© effacÃ© (wilayas + agences)', 'info');
                document.dispatchEvent(new CustomEvent('agencesUpdated'));
            }
        };
        
        // Log initial
        addLog('ğŸš€ Page de test chargÃ©e', 'success');
        addLog('âœ… Module agence-store importÃ©', 'success');
        
        // Afficher l'Ã©tat au chargement
        setTimeout(() => {
            addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            addLog('ğŸ“Š Ã‰tat actuel du systÃ¨me:', 'info');
            addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            window.showWilayas();
            addLog('', 'info');
            window.showAgences();
            addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            
            // VÃ©rifier si des wilayas existent
            const savedWilayas = localStorage.getItem('wilayas');
            if (!savedWilayas || JSON.parse(savedWilayas).length === 0) {
                addLog('', 'info');
                addLog('âš ï¸ ATTENTION: Aucune wilaya trouvÃ©e!', 'error');
                addLog('ğŸ’¡ Vous devez d\'abord ajouter des wilayas avant de pouvoir crÃ©er des agences', 'info');
                addLog('ğŸ‘‰ Cliquez sur "Ajouter des wilayas de test"', 'info');
            }
        }, 500);
        
        // Ã‰couter les Ã©vÃ©nements
        document.addEventListener('agencesUpdated', (e) => {
            addLog('ğŸ”” Ã‰vÃ©nement agencesUpdated dÃ©clenchÃ©', 'info');
        });
    </script>
</body>
</html>
