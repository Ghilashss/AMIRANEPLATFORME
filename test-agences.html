<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ajout Agence</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #0b2b24;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0a231e;
        }
        #logs {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>🧪 Test d'Ajout d'Agences</h1>
    
    <div class="test-section">
        <h2>Wilayas (Prérequis)</h2>
        <button onclick="addTestWilaya()">🌍 Ajouter des wilayas de test</button>
        <button onclick="showWilayas()">📋 Afficher les wilayas</button>
        <button onclick="clearWilayas()">🗑️ Effacer les wilayas</button>
    </div>
    
    <div class="test-section">
        <h2>Agences</h2>
        <button onclick="testAddAgence()">➕ Ajouter une agence de test</button>
        <button onclick="showAgences()">📋 Afficher toutes les agences</button>
        <button onclick="clearAgences()">🗑️ Effacer toutes les agences</button>
    </div>
    
    <div class="test-section">
        <h2>Utilitaires</h2>
        <button onclick="clearLogs()">🧹 Effacer les logs</button>
        <button onclick="clearAll()">🔥 Tout effacer (wilayas + agences)</button>
    </div>
    
    <div class="test-section">
        <h2>📊 Logs</h2>
        <div id="logs"></div>
    </div>

    <script type="module">
        import { agenceStore } from './dashboards/shared/agence-store.js';
        
        window.agenceStore = agenceStore;
        
        let logCounter = 0;
        
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logCounter++;
            logsDiv.innerHTML += `<div class="${type}">[${logCounter}] ${timestamp} - ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        window.testAddAgence = function() {
            addLog('🔵 Début du test d\'ajout d\'agence', 'info');
            
            try {
                // Vérifier qu'il y a au moins une wilaya
                const wilayas = localStorage.getItem('wilayas');
                if (!wilayas) {
                    addLog('❌ Aucune wilaya trouvée. Veuillez d\'abord ajouter une wilaya.', 'error');
                    return;
                }
                
                const wilayasArray = JSON.parse(wilayas);
                if (wilayasArray.length === 0) {
                    addLog('❌ Aucune wilaya trouvée. Veuillez d\'abord ajouter une wilaya.', 'error');
                    return;
                }
                
                const wilaya = wilayasArray[0];
                addLog(`📍 Wilaya sélectionnée: ${wilaya.code} - ${wilaya.nom}`, 'info');
                
                // Créer une agence de test
                const testAgence = {
                    nom: `Agence Test ${Date.now()}`,
                    wilaya: wilaya.code,
                    wilayaText: wilaya.nom,
                    telephone: '0555123456',
                    email: 'test@example.com',
                    password: 'test123'
                };
                
                addLog(`📦 Données de l'agence: ${JSON.stringify(testAgence, null, 2)}`, 'info');
                
                // Ajouter l'agence
                const result = agenceStore.addAgence(testAgence);
                
                addLog(`✅ Agence ajoutée avec succès: ${result.code} - ${result.nom}`, 'success');
                addLog(`🆔 ID: ${result.id}`, 'info');
                
                // Vérifier dans localStorage
                const savedAgences = localStorage.getItem('agences');
                const agencesArray = JSON.parse(savedAgences);
                addLog(`💾 Nombre d'agences dans localStorage: ${agencesArray.length}`, 'info');
                
            } catch (error) {
                addLog(`❌ Erreur: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.showAgences = function() {
            addLog('📋 Lecture des agences...', 'info');
            
            try {
                const savedAgences = localStorage.getItem('agences');
                
                if (!savedAgences) {
                    addLog('⚠️ Aucune agence trouvée dans localStorage', 'info');
                    return;
                }
                
                const agences = JSON.parse(savedAgences);
                addLog(`📊 Nombre total d'agences: ${agences.length}`, 'success');
                
                agences.forEach((agence, index) => {
                    addLog(`   ${index + 1}. ${agence.code} - ${agence.nom} (${agence.wilayaText})`, 'info');
                });
                
            } catch (error) {
                addLog(`❌ Erreur: ${error.message}`, 'error');
            }
        };
        
        window.clearAgences = function() {
            if (confirm('⚠️ Voulez-vous vraiment effacer TOUTES les agences ?')) {
                localStorage.removeItem('agences');
                addLog('🗑️ Toutes les agences ont été supprimées', 'info');
                document.dispatchEvent(new CustomEvent('agencesUpdated'));
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
            logCounter = 0;
        };
        
        window.addTestWilaya = function() {
            addLog('🌍 Ajout des wilayas de test...', 'info');
            
            const testWilayas = [
                {
                    id: "1760423519791",
                    code: "01",
                    nom: "Adrar",
                    designation: "Wilaya d'Adrar",
                    zone: "sud",
                    email: "adrar@contact.dz",
                    address: "Centre ville, Adrar",
                    password: "adrar123",
                    status: "active"
                },
                {
                    id: "1760423519792",
                    code: "16",
                    nom: "Alger",
                    designation: "Wilaya d'Alger",
                    zone: "centre",
                    email: "alger@contact.dz",
                    address: "Centre ville, Alger",
                    password: "alger123",
                    status: "active"
                },
                {
                    id: "1760423519793",
                    code: "31",
                    nom: "Oran",
                    designation: "Wilaya d'Oran",
                    zone: "ouest",
                    email: "oran@contact.dz",
                    address: "Centre ville, Oran",
                    password: "oran123",
                    status: "active"
                },
                {
                    id: "1760423519794",
                    code: "25",
                    nom: "Constantine",
                    designation: "Wilaya de Constantine",
                    zone: "est",
                    email: "constantine@contact.dz",
                    address: "Centre ville, Constantine",
                    password: "constantine123",
                    status: "active"
                }
            ];
            
            localStorage.setItem('wilayas', JSON.stringify(testWilayas));
            addLog(`✅ ${testWilayas.length} wilayas ajoutées avec succès`, 'success');
            
            testWilayas.forEach(w => {
                addLog(`   📍 ${w.code} - ${w.nom}`, 'info');
            });
        };
        
        window.showWilayas = function() {
            addLog('📋 Lecture des wilayas...', 'info');
            
            try {
                const savedWilayas = localStorage.getItem('wilayas');
                
                if (!savedWilayas) {
                    addLog('⚠️ Aucune wilaya trouvée dans localStorage', 'info');
                    addLog('💡 Cliquez sur "Ajouter des wilayas de test" pour en créer', 'info');
                    return;
                }
                
                const wilayas = JSON.parse(savedWilayas);
                addLog(`📊 Nombre total de wilayas: ${wilayas.length}`, 'success');
                
                wilayas.forEach((wilaya, index) => {
                    addLog(`   ${index + 1}. ${wilaya.code} - ${wilaya.nom} (${wilaya.zone})`, 'info');
                });
                
            } catch (error) {
                addLog(`❌ Erreur: ${error.message}`, 'error');
            }
        };
        
        window.clearWilayas = function() {
            if (confirm('⚠️ Voulez-vous vraiment effacer TOUTES les wilayas ?')) {
                localStorage.removeItem('wilayas');
                addLog('🗑️ Toutes les wilayas ont été supprimées', 'info');
            }
        };
        
        window.clearAll = function() {
            if (confirm('⚠️⚠️⚠️ Voulez-vous vraiment TOUT effacer (wilayas + agences) ?')) {
                localStorage.removeItem('wilayas');
                localStorage.removeItem('agences');
                addLog('🔥 Tout a été effacé (wilayas + agences)', 'info');
                document.dispatchEvent(new CustomEvent('agencesUpdated'));
            }
        };
        
        // Log initial
        addLog('🚀 Page de test chargée', 'success');
        addLog('✅ Module agence-store importé', 'success');
        
        // Afficher l'état au chargement
        setTimeout(() => {
            addLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            addLog('📊 État actuel du système:', 'info');
            addLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            window.showWilayas();
            addLog('', 'info');
            window.showAgences();
            addLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
            
            // Vérifier si des wilayas existent
            const savedWilayas = localStorage.getItem('wilayas');
            if (!savedWilayas || JSON.parse(savedWilayas).length === 0) {
                addLog('', 'info');
                addLog('⚠️ ATTENTION: Aucune wilaya trouvée!', 'error');
                addLog('💡 Vous devez d\'abord ajouter des wilayas avant de pouvoir créer des agences', 'info');
                addLog('👉 Cliquez sur "Ajouter des wilayas de test"', 'info');
            }
        }, 500);
        
        // Écouter les événements
        document.addEventListener('agencesUpdated', (e) => {
            addLog('🔔 Événement agencesUpdated déclenché', 'info');
        });
    </script>
</body>
</html>
