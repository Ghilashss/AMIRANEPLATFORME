<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test AuthService</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    h2 {
      color: #34495e;
      margin-top: 30px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 5px;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #2980b9;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .success {
      color: #27ae60;
      font-weight: bold;
    }
    .error {
      color: #e74c3c;
      font-weight: bold;
    }
    .info {
      color: #3498db;
      font-weight: bold;
    }
    pre {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    .log {
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border-left: 4px solid #3498db;
      border-radius: 3px;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      width: 200px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ Test AuthService - Migration API</h1>
    
    <div class="test-section">
      <h2>üìä √âtat actuel</h2>
      <div id="status"></div>
    </div>

    <div class="test-section">
      <h2>üîê Test 1: Connexion</h2>
      <input type="email" id="testEmail" placeholder="Email" value="agent@test.com">
      <input type="password" id="testPassword" placeholder="Mot de passe" value="123456">
      <br>
      <button onclick="testLogin()">Tester Connexion</button>
      <div id="loginResult"></div>
    </div>

    <div class="test-section">
      <h2>üë§ Test 2: R√©cup√©rer utilisateur</h2>
      <button onclick="testGetCurrentUser()">R√©cup√©rer User depuis API</button>
      <div id="userResult"></div>
    </div>

    <div class="test-section">
      <h2>üì° Test 3: Requ√™te authentifi√©e</h2>
      <button onclick="testFetchWithAuth()">Tester fetchWithAuth (agences)</button>
      <div id="fetchResult"></div>
    </div>

    <div class="test-section">
      <h2>üóëÔ∏è Test 4: D√©connexion</h2>
      <button onclick="testLogout()">Tester D√©connexion</button>
      <div id="logoutResult"></div>
    </div>

    <div class="test-section">
      <h2>üìã Console de logs</h2>
      <div id="logs"></div>
      <button onclick="clearLogs()">Effacer les logs</button>
    </div>
  </div>

  <script type="module">
    import AuthService from './dashboards/auth-service.js';

    // Rendre AuthService disponible globalement pour les tests
    window.AuthService = AuthService;

    // Logger personnalis√©
    window.logMessage = function(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = 'log';
      logEntry.innerHTML = `<span class="${type}">[${new Date().toLocaleTimeString()}]</span> ${message}`;
      logsDiv.insertBefore(logEntry, logsDiv.firstChild);
      console.log(message);
    };

    // Test 1: Connexion
    window.testLogin = async function() {
      const email = document.getElementById('testEmail').value;
      const password = document.getElementById('testPassword').value;
      const resultDiv = document.getElementById('loginResult');
      
      logMessage('üîê Test de connexion...', 'info');
      resultDiv.innerHTML = '<p>‚è≥ Connexion en cours...</p>';
      
      try {
        const userData = await AuthService.login(email, password);
        
        resultDiv.innerHTML = `
          <p class="success">‚úÖ Connexion r√©ussie!</p>
          <pre>${JSON.stringify(userData, null, 2)}</pre>
        `;
        logMessage(`‚úÖ Connexion r√©ussie: ${userData.email} (${userData.role})`, 'success');
        updateStatus();
      } catch (error) {
        resultDiv.innerHTML = `
          <p class="error">‚ùå Erreur de connexion</p>
          <pre>${error.message}</pre>
        `;
        logMessage(`‚ùå Erreur de connexion: ${error.message}`, 'error');
      }
    };

    // Test 2: R√©cup√©rer utilisateur
    window.testGetCurrentUser = async function() {
      const resultDiv = document.getElementById('userResult');
      
      logMessage('üë§ Test getCurrentUser...', 'info');
      resultDiv.innerHTML = '<p>‚è≥ R√©cup√©ration de l\'utilisateur...</p>';
      
      try {
        const user = await AuthService.getCurrentUser();
        
        resultDiv.innerHTML = `
          <p class="success">‚úÖ Utilisateur r√©cup√©r√©!</p>
          <pre>${JSON.stringify(user, null, 2)}</pre>
        `;
        logMessage(`‚úÖ Utilisateur r√©cup√©r√©: ${user.nom} ${user.prenom} (${user.email})`, 'success');
      } catch (error) {
        resultDiv.innerHTML = `
          <p class="error">‚ùå Erreur de r√©cup√©ration</p>
          <pre>${error.message}</pre>
        `;
        logMessage(`‚ùå Erreur getCurrentUser: ${error.message}`, 'error');
      }
    };

    // Test 3: Fetch avec auth
    window.testFetchWithAuth = async function() {
      const resultDiv = document.getElementById('fetchResult');
      
      logMessage('üì° Test fetchWithAuth...', 'info');
      resultDiv.innerHTML = '<p>‚è≥ R√©cup√©ration des agences...</p>';
      
      try {
        const data = await AuthService.fetchWithAuth('http://localhost:1000/api/agences');
        
        resultDiv.innerHTML = `
          <p class="success">‚úÖ Requ√™te r√©ussie!</p>
          <p>Nombre d'agences: ${data.count || data.data?.length || 0}</p>
          <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
        `;
        logMessage(`‚úÖ Requ√™te r√©ussie: ${data.count || data.data?.length || 0} agences`, 'success');
      } catch (error) {
        resultDiv.innerHTML = `
          <p class="error">‚ùå Erreur de requ√™te</p>
          <pre>${error.message}</pre>
        `;
        logMessage(`‚ùå Erreur fetchWithAuth: ${error.message}`, 'error');
      }
    };

    // Test 4: D√©connexion
    window.testLogout = function() {
      const resultDiv = document.getElementById('logoutResult');
      
      logMessage('üö™ Test de d√©connexion...', 'info');
      
      try {
        AuthService.logout();
        
        resultDiv.innerHTML = `<p class="success">‚úÖ D√©connexion r√©ussie!</p>`;
        logMessage('‚úÖ D√©connexion r√©ussie', 'success');
        updateStatus();
      } catch (error) {
        resultDiv.innerHTML = `
          <p class="error">‚ùå Erreur de d√©connexion</p>
          <pre>${error.message}</pre>
        `;
        logMessage(`‚ùå Erreur logout: ${error.message}`, 'error');
      }
    };

    // Effacer les logs
    window.clearLogs = function() {
      document.getElementById('logs').innerHTML = '';
    };

    // Mettre √† jour le statut
    function updateStatus() {
      const statusDiv = document.getElementById('status');
      const isAuth = AuthService.isAuthenticated();
      const token = AuthService.getToken();
      
      statusDiv.innerHTML = `
        <p><strong>Authentifi√©:</strong> <span class="${isAuth ? 'success' : 'error'}">${isAuth ? '‚úÖ Oui' : '‚ùå Non'}</span></p>
        <p><strong>Token:</strong> ${token ? `<code>${token.substring(0, 30)}...</code>` : '<span class="error">Aucun</span>'}</p>
        <p><strong>Storage:</strong> sessionStorage</p>
      `;
    }

    // Initialisation
    window.addEventListener('DOMContentLoaded', () => {
      logMessage('üöÄ Page de test charg√©e', 'success');
      updateStatus();
    });
  </script>
</body>
</html>
