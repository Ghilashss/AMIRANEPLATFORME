<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration - Ajouter createdBy aux Colis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
        }
        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        #log {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-line {
            margin: 5px 0;
        }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #ff9800; }
        .log-info { color: #2196F3; }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migration des Colis - Ajout du champ createdBy</h1>
        
        <div class="info-box">
            <strong>‚ÑπÔ∏è Information :</strong><br>
            Cette page permet de migrer les colis existants dans le localStorage pour ajouter le champ <code>createdBy</code>.
            <br><br>
            <strong>R√®gles de migration :</strong>
            <ul>
                <li>Par d√©faut, tous les colis seront marqu√©s comme cr√©√©s par <strong>'admin'</strong></li>
                <li>Vous pouvez choisir de marquer tous les colis comme cr√©√©s par <strong>'agent'</strong></li>
            </ul>
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Attention :</strong><br>
            Cette op√©ration va modifier tous les colis dans le localStorage. Une sauvegarde sera cr√©√©e automatiquement.
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Colis Total</h3>
                <div class="number" id="totalColis">-</div>
            </div>
            <div class="stat-card">
                <h3>Sans createdBy</h3>
                <div class="number" id="sanscreatedBy">-</div>
            </div>
            <div class="stat-card">
                <h3>Avec createdBy</h3>
                <div class="number" id="aveccreatedBy">-</div>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="analyzerColis()">üîç Analyser les Colis</button>
            <button onclick="migrerCommeAdmin()" class="secondary">‚úÖ Migrer comme ADMIN</button>
            <button onclick="migrerCommeAgent()" class="secondary">‚úÖ Migrer comme AGENT</button>
            <button onclick="sauvegarder()" class="secondary">üíæ Sauvegarder</button>
            <button onclick="restaurer()" class="danger">‚ôªÔ∏è Restaurer Sauvegarde</button>
        </div>

        <div class="success-box" id="successBox">
            <strong>‚úÖ Migration R√©ussie !</strong><br>
            <span id="successMessage"></span>
        </div>

        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStats() {
            const colis = JSON.parse(localStorage.getItem('colis') || '[]');
            const total = colis.length;
            const sans = colis.filter(c => !c.createdBy).length;
            const avec = colis.filter(c => c.createdBy).length;

            document.getElementById('totalColis').textContent = total;
            document.getElementById('sanscreatedBy').textContent = sans;
            document.getElementById('aveccreatedBy').textContent = avec;
        }

        function analyzerColis() {
            log('üîç Analyse des colis en cours...', 'info');
            
            const colis = JSON.parse(localStorage.getItem('colis') || '[]');
            
            if (colis.length === 0) {
                log('‚ö†Ô∏è Aucun colis trouv√© dans le localStorage', 'warning');
                updateStats();
                return;
            }

            log(`üì¶ ${colis.length} colis trouv√©s`, 'success');
            
            const sanscreatedBy = colis.filter(c => !c.createdBy);
            const aveccreatedBy = colis.filter(c => c.createdBy);

            log(`‚úÖ ${aveccreatedBy.length} colis ont d√©j√† le champ createdBy`, 'success');
            log(`‚ö†Ô∏è ${sanscreatedBy.length} colis n'ont PAS le champ createdBy`, 'warning');

            if (aveccreatedBy.length > 0) {
                const parType = {};
                aveccreatedBy.forEach(c => {
                    parType[c.createdBy] = (parType[c.createdBy] || 0) + 1;
                });
                log('üìä R√©partition actuelle:', 'info');
                Object.entries(parType).forEach(([type, count]) => {
                    log(`   - ${type}: ${count} colis`, 'info');
                });
            }

            updateStats();
        }

        function sauvegarder() {
            const colis = localStorage.getItem('colis');
            if (!colis) {
                log('‚ö†Ô∏è Aucun colis √† sauvegarder', 'warning');
                return;
            }

            localStorage.setItem('colis_backup', colis);
            const timestamp = new Date().toISOString();
            localStorage.setItem('colis_backup_date', timestamp);
            
            log('üíæ Sauvegarde cr√©√©e avec succ√®s', 'success');
            log(`üìÖ Date: ${new Date(timestamp).toLocaleString()}`, 'info');
        }

        function restaurer() {
            const backup = localStorage.getItem('colis_backup');
            if (!backup) {
                log('‚ùå Aucune sauvegarde trouv√©e', 'error');
                return;
            }

            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir restaurer la sauvegarde ? Cela √©crasera les colis actuels.')) {
                log('‚ùå Restauration annul√©e', 'warning');
                return;
            }

            localStorage.setItem('colis', backup);
            const backupDate = localStorage.getItem('colis_backup_date');
            
            log('‚ôªÔ∏è Sauvegarde restaur√©e avec succ√®s', 'success');
            if (backupDate) {
                log(`üìÖ Sauvegarde du: ${new Date(backupDate).toLocaleString()}`, 'info');
            }
            
            analyzerColis();
        }

        function migrerCommeAdmin() {
            migrer('admin');
        }

        function migrerCommeAgent() {
            migrer('agent');
        }

        function migrer(type) {
            log(`üîÑ D√©but de la migration (createdBy = '${type}')...`, 'info');
            
            // Cr√©er une sauvegarde automatique
            sauvegarder();
            
            const colis = JSON.parse(localStorage.getItem('colis') || '[]');
            
            if (colis.length === 0) {
                log('‚ö†Ô∏è Aucun colis √† migrer', 'warning');
                return;
            }

            let modified = 0;
            let skipped = 0;

            colis.forEach(c => {
                if (!c.createdBy) {
                    c.createdBy = type;
                    modified++;
                } else {
                    skipped++;
                }
            });

            localStorage.setItem('colis', JSON.stringify(colis));
            
            log(`‚úÖ Migration termin√©e !`, 'success');
            log(`   - ${modified} colis modifi√©s (createdBy = '${type}')`, 'success');
            log(`   - ${skipped} colis ignor√©s (avaient d√©j√† createdBy)`, 'info');
            
            // Afficher le message de succ√®s
            const successBox = document.getElementById('successBox');
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = `${modified} colis ont √©t√© marqu√©s comme cr√©√©s par '${type}'. ${skipped} colis avaient d√©j√† le champ createdBy.`;
            successBox.style.display = 'block';
            
            // Mettre √† jour les stats
            updateStats();
            
            // Sugg√©rer un rechargement
            setTimeout(() => {
                if (confirm('‚úÖ Migration r√©ussie ! Voulez-vous recharger la page pour appliquer les changements ?')) {
                    location.reload();
                }
            }, 1000);
        }

        // Analyser au chargement
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Script de migration charg√©', 'success');
            analyzerColis();
        });
    </script>
</body>
</html>
